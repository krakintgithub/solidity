# <p align="center">Krakin't Presale Contract (in progress)</p>
<p align="center">
  <img src="https://raw.githubusercontent.com/krakintgithub/misc/master/doodles/purchaseDoodle.png"  title="Logo" width="200px">
</p>


## <p align="center">0x0463D4fBe3823bdE3278d5BAC8Cf19f608d1e648</p>

## Introduction
### General overview

This is not a simple pre-sale swap contract. There are several aspects to keep in mind while executing it.

- This contract is a KRK sale contract that allows you to purchase KRK tokens with Ethereum.
- This contract also allows you to get your Ethereum back, with a 4% fee.
- 2% of the fee goes to Krakin't and other 2% is spread to everyone who invested.
- You can earn Ethereum with this contract as well, and cover the 4% fee.
- You can also recover from the 4% loss by using the miner and selling the newly mined tokens on a market.
- You cannot exchange more KRK to Ethereum than you have previously purchased by executing this contract.
- It does not matter where the KRK is coming from, while swapping back to Ethereum, as long as you made a purchase at some point.
- The main purpose of this contract is to encourage trading and mining.
- Every time purchase is made, new KRK tokens are minted. Every time they are swapped back to Ethereum, tokens are burned.
- The contract does not allow more than 5 million tokens to be minted and in circulation at the same time.
- Price of a token increases with the amount of purchases.
- Price of a token decreases when KRK is swapped back to Ethereum.
- Arbitrage with exchanges is possible. 

### Controlled supply vs price

Since Solidity language is limited when it comes to mathematics, instead of using a single curve formula, we are using 10 linear formulas to regulate the price of a token within the frame of this contract. Each line represents a new stage and a steeper slope. There are 10 stages in total. 

To calculate the price, assume:


x = Circulating KRK tokens (that is, generated by the contract)

f(x) = price
 
 
Then, apply these formulas:

stage 1, less than 0.5mil KRK:
- f(x) = 1.9998×10^-7 x + 0.0001

stage 2, greater than 0.5mil KRK, less than 1mil KRK:
- f(x) = 4.22202×10^-7 x - 0.111011

stage 3, greater than 1mil KRK, less than 1.5mil KRK:
- f(x) = 6.72202×10^-7 x - 0.361011

stage 4, greater than 1.5mil KRK, less than 2mil KRK:
- f(x) = 9.57917×10^-7 x - 0.789583

stage 5, greater than 2mil KRK, less than 2.5mil KRK:
- f(x) = 1.29125×10^-6 x - 1.45625

stage 6, greater than 2.5mil KRK, less than 3mil KRK:
- f(x) = 1.69125×10^-6 x - 2.45625

stage 7, greater than 3mil KRK, less than 3.5mil KRK:
- f(x) = 2.19125×10^-6 x - 3.95625

stage 8, greater than 3.5mil KRK, less than 4mil KRK:
- f(x) = 2.85792×10^-6 x - 6.28958
 
stage 9, greater than 4mil KRK, less than 4.5mil KRK:
- f(x) = 3.8579×10^-6 x - 10.2895

stage 10, greater than 4.5mil KRK:
- f(x) = 5.8579×10^-6 x - 19.2895
 

For example, if there were 51000.00 KRK tokens that are circulating and generated by the contract, it means that the price is:

f(x) = 1.9998×10^-7 x + 0.0001 = 0.01029898 (ETH/KRK)

Let us assume that you want to deposit 1.2 Ethereum to a contract. Therefore, we will calculate this as:

- Take away 4% from 1.2 to get 1.152 ETH
- Then calculate the amount of tokens by 1.152 / 0.01029898 = 111.85573717

Now, here is something else to consider.  In order to increase the yield, we multiply 111.85573717 by 1000/(stage number). 
- Therefore, you will get 111855.73717 KRK tokens.

The number of minted tokens by the contract then increases by the 51000 KRK + 111855.73717 KRK, so the next purchase for 1.2 Ethereum gives fewer tokens.

Please keep in mind, since we are using Solidity and no decimals (just big integers), the price is always going to be the best estimate lacking a certain precision while transforming everything to big integers that include 18 decimals in calculation. This is a reason why the contract line formulas and the ones presented in this document are different. Nevertheless, they represent the same numbers and logic.

### Ethereum Earnings
A brief explanation on how the earnings are calculated:
- Take 4% from the Ethereum deposit when tokens are purchased
- Allocate 2% to Krakin't
- Allocate 2% to everyone
- Mint the tokens with a 4% reduction

Allocating 2% to everyone works by adding it to a total sum of allocated Ethereum. This sum is simply divided by the number of circulating (and generated by the contract) tokens, in respect to amount of tokens that user wants to withdraw.  A simple formula therefore becomes:

<p align="center">(a^2*b) / c^2</p>

Where:

- a is circulatingUserKrk[userAddress]
- b is circulatingUserKrk[userAddress]
- c is circulatingKrk

See the variables and their meaning (below).


## Source Code Overview
### Variables and their meaning

All variables are private, and they are accessed by the getter or setter methods, thus following the common Object-Oriented design.

`maxSell` The maximum number of tokens that can be minted as circulating tokens, by this contract

`circulatingKrk` The number of tokens that were minted and are circulating

`circulatingEth` The amount of Ethereum that exists on a contract

`krakintTotalEthEarnings` Amount of available Ethereum (in Wei) Krakin't is allowed to obtain from the contract

`investorsCirculatingEthEarnings` Amount of available Ethereum (in Wei) spread to all investors

`userEth` Amount of available Ethereum an user can obtain back depositing KRK tokens

`circulatingUserKrk` Amount of minted KRK tokens, per user, that are still circulating

`totalUserFees` amount of fees (in Wei) used has paid, in total

`totalBurnedKRK` total amount of KRK that were swapped to ETH (and burned)

`totalMintedKRK` total amount of KRK that was minted by the contract

`totalDepositedEth` total amount of ETH that was deposited to a contract

`totalWitdrawnEth` total amount of ETH that was withdrawn from a contract, excluding the Krakin't earnings.

`totalFeesPaid` total amount of fees that were paid to a contract

`totalKrakintEarnings` total amount of Ethereum (in Wei) that Krakin't made

`totalInvestorsEarnings` total amount of Ethereum (in Wei) that investors made

`totalDepositAfterFees` total amount of Ethereum that was deposited, after the fees were applied

`routerContract` address to a Router contract (native token contract)

`router` for interracting with a token

`mutex` regulates the access to contract functions, against reentrancy attacks

`mutexTimeout` regulates the access to contract functions, with an expiry time of 20 minutes, against reentrancy attacks
  
### Functions
#### Main Functions

```solidity 
function purchaseTokens() external payable
```
The function used to purchase KRK tokens, fields are in Ethereum, not Wei. 
 
 
 
```solidity 
function purchaseEthereum(uint krkAmount) external returns (bool success)
 ```
 The function used to get Ethereum back from the contract. Any bonus earnings are calculated. The contract does not accept more KRK than it was generated, per user.
 
 
 
```solidity 
function mint(uint mintAmount) private returns(bool success)
 ```
 
 Private function used to mint the tokens when purchase is made.
 
 
 
```solidity 
function burn(uint burnAmount) private returns(bool success)
 ```
 Private function used to burn the tokens once they are swapped back to Ethereum.
 
 
#### View Functions
```solidity 
function getEthReturnNoBonus(uint krkAmount) public view virtual returns (uint ethAmount)
```
Show the amount of ETH that is returned for the inputted KRK amount, without any earnings. 
 
 
```solidity 
function getEthReturnBonus(uint krkAmount) public view virtual returns (uint bonusAmount)
```
Show the amount of ETH that is returned for the inputted KRK amount, with earnings. 


```solidity 
function getKrkReturn(uint gweiAmount) public view virtual returns(uint krkAmount)
```
Show the amount of KRK that is returned for the inputted ETH amount in Wei. 


```solidity 
function getCirculatingKrk() public view virtual returns (uint krkAmount)
```
A circulatingKrk getter. See the variable definition from above.


```solidity 
function getCirculatingEth() public view virtual returns (uint krkAmount)
```
A circulatingEth getter. See the variable definition from above.

 
```solidity 
function getKrakintTotalEthEarnings() public view virtual returns (uint ethAmount)
```
A krakintTotalEthEarnings getter. See the variable definition from above.


```solidity 
function getInvestorsCirculatingEthEarnings() public view virtual returns (uint ethAmount)
```
A investorsCirculatingEthEarnings getter. See the variable definition from above.


```solidity 
function getUserEth(address userAddress) public view virtual returns (uint ethAmount)
 ```
A userEth getter. See the variable definition from above.
 
```solidity 
function getCirculatingUserKrk(address userAddress) public view virtual returns (uint ethAmount)
 ```
A circulatingUserKrk getter. See the variable definition from above.
 
```solidity 
function getTotalUserFees(address userAddress) public view virtual returns (uint ethAmount)
 ```
A totalUserFees getter. See the variable definition from above.
 
```solidity 
function getTotalBurnedKRK() public view virtual returns (uint ethAmount)
 ```
A totalBurnedKRK getter. See the variable definition from above.
 
```solidity 
function getTotalMintedKRK() public view virtual returns (uint ethAmount)
 ```
A totalMintedKRK getter. See the variable definition from above.
 
```solidity 
function getTotalDepositedEth() public view virtual returns (uint ethAmount)
 ```
A totalDepositedEth getter. See the variable definition from above.

```solidity 
function getTotalWitdrawnEth() public view virtual returns (uint ethAmount)
 ```
A totalWithdrawnEth getter. See the variable definition from above. 
 
```solidity 
function getTotalFeesPaid() public view virtual returns (uint ethAmount)
 ```
A totalFeesPaid getter. See the variable definition from above. 
 
```solidity 
function getTotalKrakintEarnings() public view virtual returns (uint ethAmount)
 ```
A totalKrakintEarnings getter. See the variable definition from above.
 
```solidity 
function getTotalInvestorsEarnings() public view virtual returns (uint ethAmount)
 ```
A totalInvestorsEarnings getter. See the variable definition from above.
 
```solidity 
function getTotalDepositAfterFees() public view virtual returns (uint ethAmount)
 ```
A totalDepositAfterFees getter. See the variable definition from above.
 
 
#### Private Pure Functions
```solidity 
function getStageNumber(uint x) private pure returns(uint stageNumber)
 ```
 Returns the stage of the token sale, based on amount of tokens that were sold.
 
```solidity 
function getPrice(uint x) private pure returns(uint retPrice)
 ```
 Returns the price assuming the x number of circulating tokens.
 
 
```solidity 
function getFourPercent(uint number) private pure returns(uint fivePercent)
 ```
 Calculates 4% of a number.
 
 
```solidity 
function revertWithMutex(address userAddress) private
 ```
Reverts the function call setting back the mutex true/false values. 
 
#### User-only Functions
```solidity 
function setNewRouterContract(address newRouterAddress) onlyOwner public virtual returns(bool success)
```
Sets the Router contract of the native KRK token component. 
 
 
```solidity 
function withdrawEthereum() external onlyOwner returns (bool success)
 ```
Withdraws all ethereum earnings that Krakin't made.
